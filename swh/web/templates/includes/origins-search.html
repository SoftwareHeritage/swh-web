{% load static %}

<div class="panel panel-default" style="overflow-x: auto;">
  <div class="panel-heading">
      <h2>Search Software Heritage origins to browse</h2>
  </div>
  <div class="panel-body">
    <form class="form-horizontal" id="search_origins">
      <div class="input-group add-on">
        <input class="form-control" placeholder="Enter string pattern(s) to search for in origin urls" type="text" id="origins-url-patterns"/>
        <div class="input-group-btn">
          <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-search"></i></button>
        </div>
      </div>
    </form>

    <div class="swh-loading">
      <img src="{% static 'img/swh-spinner.gif' %}"></img>
      <p>Searching origins ...</p>
    </div>

    <div class="table-responsive">
      <table class="table" id="origin-search-results">
        <thead>
          <tr>
            <th>Origin type</th>
            <th>Origin browse url</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <ul class="pager">
      <li class="disabled" id="origins-prev-results-button"><a href="#">Previous</a></li>
      <li class="disabled" id="origins-next-results-button"><a href="#">Next</a></li>
    </ul>
  </div>
</div>
<script>

  var origin_patterns;
  var per_page = 15;
  var offset = 0;
  var origins_search_url = "{% url 'browse-origin-search' 'url_regexp' %}?limit=limit_val&offset=offset_val&regexp=true";
  var origin_browse_url = "{% url 'browse-origin' 'type' 'origin_url' %}";
  var search_request = null;

  function populateOriginSearchResultsTable(data, limit, offset) {
    $("#origin-search-results tbody tr").remove();
    var table = $("#origin-search-results tbody");
    $.each(data, function(idx, elem){
      var tableRow = '<tr>';
      tableRow += '<td>' + elem.type + '</td>';
      var browse_url = origin_browse_url.replace('type', elem.type).replace('origin_url', elem.url);
      tableRow += '<td><a href="' + browse_url + '">' + browse_url + '</a></td>';
      tableRow += '</tr>';
      table.append(tableRow);
    });
    if (data.length == per_page) {
      $('#origins-next-results-button').removeClass('disabled');
    } else {
      $('#origins-next-results-button').addClass('disabled');
    }
    if (offset > 0) {
      $('#origins-prev-results-button').removeClass('disabled');
    } else {
      $('#origins-prev-results-button').addClass('disabled');
    }
  }

  $(document).ready(function() {
    if (typeof(Storage) !== "undefined") {
      origin_patterns = sessionStorage.getItem("last-swh-origin-url-patterns");
      var data = sessionStorage.getItem("last-swh-origin-search-results");
      offset = sessionStorage.getItem("last-swh-origin-search-offset");
      if (data) {
        $("#origins-url-patterns").val(origin_patterns);
        offset = parseInt(offset);
        populateOriginSearchResultsTable(JSON.parse(data), per_page, offset);
      }
    }
  });

  // http://dsernst.com/2014/12/14/heaps-permutation-algorithm-in-javascript/
  function swap(array, pos1, pos2) {
    var temp = array[pos1];
    array[pos1] = array[pos2];
    array[pos2] = temp;
  }

  function heapsPermute(array, output, n) {
    n = n || array.length; // set n default to array.length
    if (n === 1) {
      output(array);
    } else {
      for (var i = 1; i <= n; i += 1) {
        heapsPermute(array, output, n - 1);
        if (n % 2) {
          var j = 1;
        } else {
          var j = i;
        }
        swap(array, j - 1, n - 1); // -1 to account for javascript zero-indexing
      }
    }
  };

  function searchOrigins(patterns, limit, offset) {
    origin_patterns = patterns;
    var patterns_array = patterns.trim().replace(/\s+/g,' ').split(' ');
    var patterns_permut = []
    heapsPermute(patterns_array, function(p) {patterns_permut.push(p.join('.*'));})
    var regex = patterns_permut.join('|');
    var search_url = origins_search_url.replace('url_regexp', regex)
                                       .replace('limit_val', limit)
                                       .replace('offset_val', offset);
    if (search_request) {
      search_request.abort();
    }
    $(".swh-loading").addClass('show');
    search_request = $.ajax({
      url: search_url,
      dataType: 'json',
      error: function() {
        search_request = null;
        $(".swh-loading").removeClass('show');
      },
      success: function (data) {
        search_request = null;
        if (typeof(Storage) !== "undefined") {
          sessionStorage.setItem("last-swh-origin-url-patterns", patterns);
          sessionStorage.setItem("last-swh-origin-search-results", JSON.stringify(data));
          sessionStorage.setItem("last-swh-origin-search-offset", offset);
        }
        populateOriginSearchResultsTable(data, per_page, offset);
        $(".swh-loading").removeClass('show');

      }
    });
  }

  $("#search_origins").submit(function (event) {
    var patterns = $("#origins-url-patterns").val();
    offset = 0;
    searchOrigins(patterns, per_page, offset);
    event.preventDefault();
  });

  $("#origins-next-results-button").click(function (event) {
    offset += per_page;
    searchOrigins(origin_patterns, per_page, offset);
    event.preventDefault();
  });

  $("#origins-prev-results-button").click(function (event) {
    offset -= per_page;
    searchOrigins(origin_patterns, per_page, offset);
    event.preventDefault();
  });

  </script>