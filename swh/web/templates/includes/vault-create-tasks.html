{% if vault_cooking %}
  <a class="btn btn-md btn-swh btn-swh-vault" data-placement="bottom" data-popover-content="#vault-popover" data-toggle="popover" href="#" tabindex="0">
    <i class="fa fa-download fa-fw" aria-hidden="true"></i>Download
  </a>
  <div class="hidden" id="vault-popover">
    <div class="popover-heading">
      Request download from the Software Heritage Vault
    </div>
    <div class="popover-body">
      <div class="btn-group-vertical">
        {% if vault_cooking.directory_context %}
          <button id="vault-cook-directory" type="button" class="btn btn-md btn-swh" data-toggle="modal" data-target="#vault-cook-directory-modal">Cook a standard archive from the current directory</button>
        {% endif %}
        {% if vault_cooking.revision_context %}
          <button id="vault-cook-revision" type="button" class="btn btn-md btn-swh" data-toggle="modal" data-target="#vault-cook-revision-modal">Cook a git fast-import archive from the current revision</button>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="modal fade" id="vault-cook-directory-modal" tabindex="-1" role="dialog" aria-labelledby="vault-cook-directory-modal-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="vault-cook-directory-modal-label">Cook and download a directory from the Software Heritage Vault</h4>
        </div>
        <div class="modal-body">
          <p>
            You have requested the cooking of the directory with identifier <strong>{{ vault_cooking.directory_id }}</strong>
            into a standard tar.gz archive.
          </p>
          <p>
            Are you sure you want to continue ?
          </p>
          <form>
            <div class="form-group">
              <label for="email">(Optional) Send download link once it is available to that email address:</label>
              <input type="email" class="form-control" id="swh-vault-directory-email">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-md btn-swh" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-md btn-swh" onclick="vault_cook_directory_archive()">Ok</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="vault-cook-revision-modal" tabindex="-1" role="dialog" aria-labelledby="vault-cook-revision-modal-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="vault-cook-revision-modal-label">Cook and download a revision from the Software Heritage Vault</h4>
        </div>
        <div class="modal-body">
          <p>
            You have requested the cooking of the revision with identifier <strong>{{ vault_cooking.revision_id }}</strong>
            into a git fast-import archive.
          </p>
          <p>
            Are you sure you want to continue ?
          </p>
          <form>
            <div class="form-group">
              <label for="email">(Optional) Send download link once it is available to that email address:</label>
              <input type="email" class="form-control" id="swh-vault-revision-email">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-md btn-swh" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-md btn-swh" onclick="vault_cook_revision_archive()">Ok</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="invalid-email-modal" tabindex="-1" role="dialog" aria-labelledby="invalid-email-modal-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="invalid-email-modal-label">Invalid Email !</h4>
        </div>
        <div class="modal-body">
          <p>The provided email is not well-formed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-md btn-swh" data-dismiss="modal">Ok</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    var cook_dir_url = "{% url 'vault-cook-directory' 'ffff' %}";
    var cook_rev_url = "{% url 'vault-cook-revision_gitfast' 'ffff' %}";
    function add_vault_cooking_task(cooking_task) {
      var vault_cooking_tasks = JSON.parse(sessionStorage.getItem("swh-vault-cooking-tasks"));
      if (!vault_cooking_tasks) {
        vault_cooking_tasks = [];
      }
      if (vault_cooking_tasks.find(function(val) {
          return val.object_type == cooking_task.object_type &&
                  val.object_id == cooking_task.object_id}) == undefined) {
        var cooking_url;
        if (cooking_task.object_type == 'directory') {
          cooking_url = cook_dir_url.replace('ffff', cooking_task.object_id);
        } else {
          cooking_url = cook_rev_url.replace('ffff', cooking_task.object_id);
        }
        if (cooking_task.email) {
          cooking_url += "?email=" + cooking_task.email;
        }
        $.ajax({
          url : cooking_url,
          type : 'POST',
          success: function() {
            vault_cooking_tasks.push(cooking_task);
            sessionStorage.setItem("swh-vault-cooking-tasks", JSON.stringify(vault_cooking_tasks));
            show_tab('#vault');
          }
        });
      }
    }
    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }
    function vault_cook_directory_archive() {
      var email = $('#swh-vault-directory-email').val().trim();
      if (!email || validateEmail(email)) {
        $('#vault-cook-directory-modal').modal('hide');
        var cooking_task = {'object_type': 'directory',
                            'object_id': '{{ vault_cooking.directory_id }}',
                            'email': email,
                            'status': 'new'};
        add_vault_cooking_task(cooking_task);

      } else {
        $('#invalid-email-modal').modal('show');
      }
    }
    function vault_cook_revision_archive() {
      var email = $('#swh-vault-revision-email').val().trim();
      if (!email || validateEmail(email)) {
        $('#vault-cook-revision-modal').modal('hide');
        var cooking_task = {'object_type': 'revision',
                            'object_id': '{{ vault_cooking.revision_id }}',
                            'email': email,
                            'status': 'new'};
        add_vault_cooking_task(cooking_task);
      } else {
        $('#invalid-email-modal').modal('show');
      }
    }
  </script>
{% endif %}