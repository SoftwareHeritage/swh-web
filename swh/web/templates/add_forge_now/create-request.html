{% extends "../layout.html" %}

{% comment %}
Copyright (C) 2022  The Software Heritage developers
See the AUTHORS file at the top-level directory of this distribution
License: GNU Affero General Public License version 3, or any later version
See top-level LICENSE file for more information
{% endcomment %}

{% load render_bundle from webpack_loader %}
{% load static %}

{% block header %}
{% render_bundle 'add_forge' %}
{% endblock %}

{% block title %}
Add forge now – Software Heritage archive
{% endblock %}

{% block navbar-content %}
<h4>Request the addition of a forge into the archive</h4>
{% endblock %}

{% block content %}
<div class="col-md-12 offset-md-1">
  <div class="col-md-8">
    <h5 class="d-flex justify-content-between align-items-center mb-3">
    </h5>
    <p style="margin-top: 1rem;">
      “Add forge now” provides a service for Software Heritage users to save a
      complete forge in the Software Heritage archive by requesting the addition
      of the forge URL into the list of regularly visited forges.
      {% if not user.is_authenticated %}
      <p>
        You can submit an “Add forge now” request only when you are authenticated,
        please login to submit the request.
      </p>
      {% endif %}
    </p>
  </div>

  <!-- Tabs in the page -->
  <div class="col-md-8">
    <ul class="nav nav-tabs">
      <li class="nav-item"><a class="nav-link active" data-toggle="tab" id="swh-add-forge-tab" href="#swh-add-forge-submit-request">Submit a Request</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" id="swh-add-forge-requests-list-tab" href="#swh-add-forge-requests-list">Browse Requests</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" id="swh-add-forge-requests-help-tab" href="#swh-add-forge-requests-help">Help</a></li>
    </ul>

    <div class="tab-content">
      <div id="swh-add-forge-submit-request" class="tab-pane active" style="padding-top: 10px;">
        {% if not user.is_authenticated %}
        <h3>
          <p class="text-primary">
            You must be logged in to submit an add forge request. Please
            <a id="loginLink" class="link-primary"
            {% if oidc_enabled and 'remote_user' in request.GET %}
              href="{% url 'oidc-login' %}?next={% url 'forge-add' %}"
            {% else %}
              href="{% url 'login' %}?next={% url 'forge-add' %}"
            {% endif %}
            >log in</a>
          </p>
        </h3>
        {% else %}

        <form method="POST" action="{% url 'api-1-add-forge-request-create' %}"
              id="requestCreateForm" class="collapse show">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-type" class="swh-required-label">Forge type</label>
              <select class="form-control" id="swh-input-forge-type" name="forge_type" autofocus>
                {% for forge_type in forge_types %}
                <option value={{ forge_type }}>{{ forge_type}}</option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">
                Supported forge types in software archive.
              </small>
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-url" class="swh-required-label">Forge URL</label>
              <input type="text" class="form-control" id="swh-input-forge-url" name="forge_url" required>
              <small class="form-text text-muted">
                Remote URL of the forge.
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-contact-name" class="swh-required-label">Forge contact name</label>
              <input type="text" class="form-control" name="forge_contact_name" id="swh-input-forge-contact-name" required>
              <small class="form-text text-muted">
                Name of the forge administrator.
              </small>
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-contact-email" class="swh-required-label">Forge contact email</label>
              <input type="email" class="form-control" name="forge_contact_email" id="swh-input-forge-contact-email" required>
              <small class="form-text text-muted">
                Email of the forge administrator. The given email address will not be used for any purpose outside the “add forge now” process.
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group form-check">
              <input class="form-check-input" type="checkbox"
                     id="swh-input-consent-check" name="submitter_forward_username">
              <label for="swh-input-consent-check">
                I consent to add my username in the communication with the forge.
              </label>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="swh-input-forge-comment">Comment</label>
              <textarea class="form-control" id="swh-input-forge-comment" name="forge_contact_comment" rows="3"></textarea>
              <small class="form-text text-muted">
                Optionally, leave a comment to the moderator regarding your request.
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <input id="swh-input-form-submit" type="submit" value="Submit Add Request" class="btn btn-default float-right">
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <h3 class="text-center">
                <span id="userMessage" class="badge"></span>
              </h3>
              <p class="text-center">
                <span id="userMessageDetail"></span>
              </p>
            </div>
          </div>
        </form>
        <p>
          Once an add-forge-request is submitted, its status can be viewed in
          the <a id="swh-show-forge-add-requests-list" href="#browse-requests">
          submitted requests list</a>. This process involves a moderator approval and
          might take a few days to handle (it primarily depends on the response
          time from the forge).
        </p>
        {% endif %}
      </div>
      <div id="swh-add-forge-requests-list" class="tab-pane fade show">
        <table id="add-forge-request-browse" class="table swh-table swh-table-striped" style="width: 100%;">
          <thead>
            <tr>
              <th>Submission date</th>
              <th>Forge type</th>
              <th>Forge URL</th>
              <th>Status</th>
            </tr>
          </thead>
        </table>
        <div id="add-forge-browse-request-error"></div>
      </div>
      <div id="swh-add-forge-requests-help" class="tab-pane fade show">
        <p style="margin-top: 1rem;">
          For submitting an "Add forge now" request", you have to provide the following details:
        </p>
        <ul>
          <li><strong>Forge type:</strong>Type of the forge you would like to add.
            Supported forge types in software heritage currently are:
            <ul>
              <li><code>cgit</code>, for <a href="https://git.zx2c4.com/cgit/">cgit</a> forges</li>
              <li><code>gitea</code>, for <a href="https://gitea.io/en-us/">gitea</a> forges</li>
              <li><code>gitlab</code>, for <a href="https://about.gitlab.com/install/">gitlab</a> forges</li>
              <li><code>heptapod</code>, for <a href="https://heptapod.net/">heptapod</a> forges</li>
              ...
            </ul>
          </li>
          <li><strong>Forge url:</strong>The URL of the selected forge. This must be unique.
          </li>
          <li><strong>Forge contact name:</strong>Contact name of the forge administrator
          </li>
          <li><strong>Forge contact email:</strong>Contact email of the forge administrator. An email
          will be sent to the given address to notify about the request.
          </li>
          <li><strong>Consent checkbox:</strong> This checkbox's purpose is to know whether we can
          explicitly mention the user's login within the email sent to the forge. If
          not checked, the user's name won't be mentioned in the email at all.
          </li>
          <li><strong>Comment:</strong> (Optionally) For the user to mention something more about
          their request to the add-forge-now moderator.
          </li>
        </ul>
        <p style="margin-top: 1rem;">
          Once submitted, your "add forge" request can be in one
          of the following states
        </p>
        <ul>
          <li>
            <strong>Pending:</strong>
            The request was submitted and is waiting for a moderator
            to validate
          </li>

          <li>
            <strong>Waiting for feedback:</strong>
            The request was processed by a moderator and the forge was contacted.
          </li>

          <li>
            <strong>Feedback to handle:</strong>
            The forge has responded to the request and
            there is feedback to handle for the request.
          </li>
          <li>
            <strong>Accepted:</strong>
            The request has been accepted.
          </li>

          <li>
            <strong>Scheduled:</strong>
            The requested forge listing has been scheduled.
          </li>

          <li>
            <strong>First listing done:</strong>
            The first listing of the requested forge has been completed
          </li>

          <li>
            <strong>First origin loaded:</strong>
            The first repositories (or origins) from the requested forge have been loaded and archived.
          </li>

          <li><strong>Rejected:</strong>The request is invalid. It is rejected by a moderator with an explanation.</li>

          <li><strong>Denied:</strong>The forge administrator(s) denied the request to list their forge.</li>

          <li><strong>Suspended:</strong>The forge listing is not supported yet.</li>
        </ul>
      </div>
    </div>
  </div>

<script>
  swh.add_forge.onCreateRequestPageLoad();
</script>

{% endblock %}
