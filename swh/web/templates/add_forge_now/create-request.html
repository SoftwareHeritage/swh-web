{% extends "../layout.html" %}

{% comment %}
Copyright (C) 2022  The Software Heritage developers
See the AUTHORS file at the top-level directory of this distribution
License: GNU Affero General Public License version 3, or any later version
See top-level LICENSE file for more information
{% endcomment %}

{% load render_bundle from webpack_loader %}
{% load static %}

{% block header %}
{% render_bundle 'add_forge' %}
{% endblock %}

{% block title %}{{ heading }} &ndash; Software Heritage archive{% endblock %}

{% block navbar-content %}
<h4>Add forge now</h4>
{% endblock %}

{% block content %}
<div class="col-md-12 offset-md-1">
  <div class="col-md-8">
    <h5 class="d-flex justify-content-between align-items-center mb-3">
      <a class="link-info" data-toggle="collapse" href="#swh-forge-add-request-help" role="button" aria-expanded="false">
        <span class="text-muted">Help to add a forge request</span>
      </a>
    </h5>
    <p>
    <p style="margin-top: 1rem;">A "Add forge now" request takes the following parameters:</p>
    </p>
    <ul>
      <li><b>Forge type:</b> the type of supported forge the software archive is able to list.
        Currently, the supported types are:
        <ul>
          <li><code>cgit</code>, for <a href="https://git.zx2c4.com/cgit/">cgit</a> forges</li>
          <li><code>gitlab</code>, for <a href="https://about.gitlab.com/install/">gitlab</a> forges</li>
          <li><code>heptapod</code>, for <a href="https://heptapod.net/">heptapod</a> forges</li>
        </ul>
      </li>
      <li><b>Forge url:</b> the url of the remote forge to list.<br/>
      </li>
    </ul>
    <div id="swh-forge-add-request-help" class="collapse tab-pane active">
      <p>
        Once submitted, your "add forge" request can either be:
      </p>
      <ul>
        <li><b>accepted:</b> a listing of the provided forge will then be scheduled by Software Heritage in order to
          load its content into the archive as soon as possible</li>
        <li><b>rejected:</b> the provided forge url is blacklisted and no listing will be scheduled</li>
        <li>put in <b>pending</b> state: a manual review will then be performed in order to determine if the
          forge can be safely listed</li>
      </ul>
      <p>
        Once a forge request has been accepted, you can follow its current status in the
        <a id="swh-show-forge-add-requests-list" href="#swh-forge-add-requests-list">submitted forge add requests list</a>.
      </p>
    </div>
  </div>

  <div class="col-md-8">
    <ul class="nav nav-tabs">
      <li class="nav-item"><a class="nav-link active" data-toggle="tab" id="swh-add-forge-requests-list-tab" href="#swh-add-forge-submit-request">Submit a Request</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" id="swh-add-forge-requests-list-tab" href="#swh-add-forge-requests-list">Browse Requests</a></li>
    </ul>

    <div class="tab-content">
      <div id="swh-add-forge-submit-request" class="tab-pane active" style="padding-top: 10px;">
        {% if not user.is_authenticated %}
        <h3>
          <p class="text-warning">
            You must be logged in to submit an add forge request. Please <a href="fsdf" class="link-info">log in here</a>
          </p>
        </h3>
        {% else %}
        <form method="POST" action="{% url 'api-1-add-forge-request-create' %}"
              id="requestForm" class="collapse {% if user.is_authenticated %} show {% endif %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-type">Forge type</label>
              {{ request_form.forge_type }}
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-url">Forge url</label>
              {{ request_form.forge_url }}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-contact-name">Forge contact name</label>
              {{ request_form.forge_contact_name }}
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-contact-email">Forge contact email</label>
              {{ request_form.forge_contact_email }}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="">
                <label for="flexCheckDefault">
                  I accept to be added with my username in the communication with the forge
                </label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="swh-input-forge-comment">Comment</label>
              {{ request_form.forge_contact_comment }}
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <input type="submit" value="Submit Add Request" class="btn btn-secondary float-right">
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <h3 class="text-center">
                <span id="userMessage" class="badge"></span>
              </h3>
            </div>
          </div>
        </form>
        {% endif %}
      </div>

      <div id="swh-add-forge-requests-list" class="tab-pane">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Type</th>
              <th scope="col">URL</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for each in existing %}
            <tr>
              <td>{{ each.submission_date }}</td>
              <td>{{ each.forge_type }}</td>
              <td>{{ each.forge_url }}</td>
              <td>{{ each.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  swh.add_forge.initAddForge()
</script>

{% endblock %}
