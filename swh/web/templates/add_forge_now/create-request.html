{% extends "../layout.html" %}

{% comment %}
Copyright (C) 2022  The Software Heritage developers
See the AUTHORS file at the top-level directory of this distribution
License: GNU Affero General Public License version 3, or any later version
See top-level LICENSE file for more information
{% endcomment %}

{% load render_bundle from webpack_loader %}
{% load static %}

{% block header %}
{% render_bundle 'add_forge' %}
{% endblock %}

{% block title %}{{ heading }} &ndash; Software Heritage archive{% endblock %}

{% block navbar-content %}
<h4>Add forge now</h4>
{% endblock %}

{% block content %}
<div class="col-md-12 offset-md-1">
  <div class="col-md-8">
    <h5 class="d-flex justify-content-between align-items-center mb-3">
    </h5>
    <p style="margin-top: 1rem;">
      “Add forge now” provides a service for Software Heritage users to save a
      complete forge in the Software Heritage archive by requesting the addition
      of the forge url into the list of regularly visited forges.

      You can submit an “Add forge now” request only when you are authenticated,
      please login to submit request.
    </p>
  </div>

  <div class="col-md-8">
    <ul class="nav nav-tabs">
      <li class="nav-item"><a class="nav-link active" data-toggle="tab" id="swh-add-forge-requests-list-tab" href="#swh-add-forge-submit-request">Submit a Request</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="tab" id="swh-add-forge-requests-list-tab" href="#swh-add-forge-requests-list">Browse Requests</a></li>
    </ul>

    <div class="tab-content">
      <div id="swh-add-forge-submit-request" class="tab-pane active" style="padding-top: 10px;">
        {% if not user.is_authenticated %}
        <h3>
          <p class="text-warning">
            You must be logged in to submit an add forge request. Please
            <a href="{% url 'login' %}" class="link-info">log in here</a>
          </p>
        </h3>
        {% else %}
        <p style="margin-top: 1rem;">A "Add forge now" request takes the following parameters:</p>
        <ul>
          <li><b>Forge type:</b> the type of supported forge the software archive is able to list.
            Currently, the supported types are:
            <ul>
              <li><code>cgit</code>, for <a href="https://git.zx2c4.com/cgit/">cgit</a> instances</li>
              <li><code>gitlab</code>, for <a href="https://about.gitlab.com/install/">gitlab</a> instances</li>
              <li><code>heptapod</code>, for <a href="https://heptapod.net/">heptapod</a> instances</li>
            </ul>
          </li>
          <li><b>Forge url:</b> the url of the remote forge to list.<br/>
          </li>
          <li><b>Forge contact email:</b> the email of the fogre’s administrator.<br />
          </li>
          <li><b>Forge contact name:</b> the name of the fogre’s administrator.<br />
          </li>
          <li><b>Comment:</b> if you wish to leave a comment regarding your request.<br />
          </li>
        </ul>
        <a class="link-info" data-toggle="collapse" href="#swh-forge-add-request-help" role="button" aria-expanded="false">
          <h6>For more information<h6>
        </a>
        <div id="swh-forge-add-request-help" class="collapse tab-pane active">
          <p>
            Once submitted, your "add forge" request can either be:
          </p>
          <ul>
            <li><b>Pending:</b> the request was submitted and is waiting for a moderator
            to check its validity.</li>

            <li><b>Waiting for feedback:</b> the request was processed by a moderator
            and the forge was contacted, the request is waiting for feedback from the
            forge.</li>

            <li><b>Feedback to handle:</b> the forge has responded to the request and
            there is feedback to handle for the request.</li>

            <li><b>Accepted:</b> the request has been accepted and waiting to be
            scheduled.</li>

            <li><b>Scheduled:</b> the request has been scheduled is considered
            done.</li>

            <li><b>First listing done:</b> The first listing of the forge is
            completed.</li>

            <li><b>First origin loaded:</b> The first origin or repository processed by
            loader and archived (using a search query).</li>

            <li><b>Rejected:</b> the request is not a valid request and is rejected by a
            Software Heritage moderator.</li>

            <li><b>Denied:</b> the forge has requested not to archive the forge.</li>

            <li><b>Suspended:</b> the request is for a forge with a non supported
            VCS.</li>
          </ul>
          <p>
            Once a add request has been submitted, you can follow its current status in
            the <a id="swh-show-forge-add-requests-list"
            href="#swh-add-forge-requests-list">submitted requests list</a>. This
            process is depending on human interactions and might take a few days to be
            handled (it primarily depends on the response time of the forge).
          </p>
        </div>

        <form method="POST" action="{% url 'api-1-add-forge-request-create' %}"
              id="requestForm" class="collapse {% if user.is_authenticated %} show {% endif %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-type">Forge type</label>
              {{ request_form.forge_type }}
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-url">Forge url</label>
              {{ request_form.forge_url }}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-5">
              <label for="swh-input-forge-contact-name">Forge contact name</label>
              {{ request_form.forge_contact_name }}
            </div>

            <div class="form-group col-md-7">
              <label for="swh-input-forge-contact-email">Forge contact email</label>
              {{ request_form.forge_contact_email }}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="">
                <label for="flexCheckDefault">
                  I accept to be added with my username in the communication with the forge
                </label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="swh-input-forge-comment">Comment</label>
              {{ request_form.forge_contact_comment }}
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <input type="submit" value="Submit Add Request" class="btn btn-secondary float-right">
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-12">
              <h3 class="text-center">
                <span id="userMessage" class="badge"></span>
              </h3>
            </div>
          </div>
        </form>
        {% endif %}
      </div>

      <div id="swh-add-forge-requests-list" class="tab-pane">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Type</th>
              <th scope="col">URL</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for each in existing %}
            <tr>
              <td>{{ each.submission_date }}</td>
              <td>{{ each.forge_type }}</td>
              <td>{{ each.forge_url }}</td>
              <td>{{ each.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  swh.add_forge.initAddForge()
</script>

{% endblock %}
