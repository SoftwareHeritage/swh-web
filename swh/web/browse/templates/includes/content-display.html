{% comment %}
Copyright (C) 2017-2025  The Software Heritage developers
See the AUTHORS file at the top-level directory of this distribution
License: GNU Affero General Public License version 3, or any later version
See top-level LICENSE file for more information
{% endcomment %}

{% load swh_templatetags %}

{% include "./revision-info.html" %}
{% if snapshot_context and snapshot_context.is_empty %}
  {% include "./empty-snapshot.html" %}
{% else %}
  {% if not iframe_mode %}
    <div class="card">
      <div class="swh-content-filename card-header swh-background-gray swh-heading-color">
        {% if filename %}{{ filename }}{% endif %}
        <div class="ms-auto float-end swh-preview-code-switch d-none">
          <div class="btn-group" role="group">
            <input type="radio"
                   class="btn-check"
                   name="preview-code-switch"
                   id="code-switch"
                   autocomplete="off"
                   checked>
            <label class="btn btn-secondary btn-sm"
                   for="code-switch"
                   id="code-switch-label"
                   onclick="switchToCode()">Code</label>
            <input type="radio"
                   class="btn-check"
                   name="preview-code-switch"
                   id="preview-switch"
                   autocomplete="off">
            <label class="btn btn-secondary btn-sm"
                   id="preview-switch-label"
                   for="preview-switch"
                   onclick="switchToPreview()">Preview</label>
          </div>
        </div>
      </div>
    {% endif %}
    <div class="swh-content">
      {% if content_size > max_content_size %}
        Content is too large to be displayed (size is greater than {{ max_content_size|filesizeformat }}).
      {% elif "application/pdf" == mimetype %}
        <div class="text-center">
          <div class="py-2">
            <button class="btn btn-secondary btn-sm" id="pdf-prev">Previous</button>
            <span>Page: <span id="pdf-page-num"></span> / <span id="pdf-page-count"></span></span>
            <button class="btn btn-secondary btn-sm" id="pdf-next">Next</button>
          </div>
          <canvas id="pdf-canvas"></canvas>
        </div>
      {% elif filename|is_notebook %}
        <div class="swh-ipynb swh-preview-content"></div>
        <div class="highlightjs">
          <pre><code class="{{ language }}">{{ content }}</code></pre>
        </div>
      {% elif filename|is_markdown or "text/html" == mimetype %}
        <iframe class="swh-html-content swh-preview-content"
                style="width: 100%;
                       height: 100vh">
        </iframe>
        <div class="highlightjs">
          <pre><code class="{{ language }}">{{ content }}</code></pre>
        </div>
      {% elif "inode/x-empty" == mimetype %}
        <i>File is empty</i>
      {% elif mimetype in browsers_supported_image_mimes and content %}
        <img src="data:{{ mimetype }};base64,{{ content }}" alt="image" />
      {% elif "text/" in mimetype or "application/" in mimetype or "message/" in mimetype and encoding != "binary" %}
        <div class="highlightjs">
          <pre><code class="{{ language }}">{{ content }}</code></pre>
        </div>
      {% elif content %}
        Content with mime type {{ mimetype }} and encoding {{ encoding }} cannot be displayed.
      {% else %}
        {% include "includes/http-error.html" %}
      {% endif %}
    </div>
    {% if not iframe_mode %}</div>{% endif %}
  {% if content %}
    <script>
      {% if "application/pdf" == mimetype %}
        swh.webapp.renderPdf({{ top_right_link.url|jsonify }});
      {% elif filename|is_markdown or "text/html" == mimetype %}
        // scripts executed in the iframe rendering html to automatically resize it and
        // forward clicked links to parent page
        const iframeScripts =
          `<script class="swh-iframe-script" async src="/static/jssources/@iframe-resizer/child/index.umd.js"><\/script>
           <script class="swh-iframe-script" src="{{ mathjax_js_library }}"><\/script>
           <script class="swh-iframe-script">
            function linkClicked(event) {
              event.preventDefault();
              let hrefVal = event.target.href;
              if (!hrefVal && event.target.parentElement) {
                hrefVal = event.target.parentElement.href;
              }
              parent.postMessage({eventType: 'link', href: hrefVal}, '*');
            }
            const links = document.querySelectorAll('a');
            for (let c = 0; c < links.length; c++) {
              links[c].addEventListener('click', linkClicked);
            }
            swh.mathjax.typesetMath();
           <\/script>`;
        // handle links clicked in iframe to allow navigation between pages
        $(window).on('message', event => {
          event = event.originalEvent;
          if (event && event.data && event.data.hasOwnProperty("eventType")) {
            if (event.data.eventType == 'link') {
              const url = new URL(event.data.href);
              if (url.origin === window.location.origin) {
                // follow relative link by reloading page
                url.searchParams.set("show_preview", "true");
                window.location = url.toString();
              } else {
                // open external link in new tab
                window.open(url.toString(), "_blank").focus();
              }
            }
          }
        });
      {% endif %}

      {% if content %}
        let previewInit = false;
        function initHtmlPreview() {
          {% if filename|is_notebook %}
            swh.webapp.renderNotebook({{ top_right_link.url|jsonify }}, '.swh-ipynb');
            previewInit = true;
          {% elif filename|is_markdown or "text/html" == mimetype %}
            fetch({{ top_right_link.url|jsonify }})
              .then(response => response.text())
              .then(async data => {
                {% if filename|is_markdown %}
                const html = await swh.webapp.renderMarkdownWithMath(data);
                {% else %}
                const html = data;
                {% endif %}
                const sanitizedHtml = swh.webapp.filterXSS(html, true);
                $('.swh-html-content').attr('srcdoc',
                  '<div data-iframe-size>' + sanitizedHtml + '<\/div>' + iframeScripts);
                swh.webapp.resizeIframe(
                  {license: 'GPLv3', waitForLoad: true, heightCalculationMethod: 'taggedElement'},
                  '.swh-html-content');
                previewInit = true;
              });
          {% endif %}
        }

        function switchToCode() {
          $('.swh-preview-content').css('display', 'none');
          $('.highlightjs').css('display', 'block');
          $('#code-switch').prop('checked', true);
          $('#preview-switch').prop('checked', false);
          const url = new URL(window.location.href);
          url.searchParams.delete('show_preview');
          window.history.replaceState({}, '', url.toString());
        }
        function switchToPreview() {
          if (!previewInit) {
            initHtmlPreview();
          }
          $('.swh-preview-content').css('display', 'block');
          $('.highlightjs').css('display', 'none');
          $('#code-switch').prop('checked', false);
          $('#preview-switch').prop('checked', true);
          const url = new URL(window.location.href);
          url.searchParams.set('show_preview', "true");
          window.history.replaceState({}, '', url.toString());
        }

        {% if filename|is_notebook %}
          $('.swh-preview-code-switch').removeClass('d-none');
          // render notebook by default to keep existing behavior
          switchToPreview();
        {% elif filename|is_markdown or "text/html" == mimetype %}
          // for html rendering the process is only executed when user is
          // requesting preview
          if ($('.swh-preview-content').length) {
            $('.swh-preview-code-switch').removeClass('d-none');
            $('.swh-preview-content').css('display', 'none');
          }

          const url = new URL(window.location.href);
          if (url.searchParams.has("show_preview")) {
            switchToPreview();
          }
        {% endif %}

        let codeContainer = $('code');
        let content = codeContainer.text();

        swh.webapp.highlightCode(true, '.swh-content code', !{{ iframe_mode|jsonify }});

        function updateLanguage(language) {
          codeContainer.text(content);
          codeContainer.removeClass();
          codeContainer.addClass(language);

          let urlParams = new URLSearchParams(window.location.search);
          urlParams.set('language', language);

          const newUrl = window.location.pathname + '?' + urlParams.toString() + window.location.hash;
          window.history.replaceState('', document.title, newUrl);

          swh.webapp.highlightCode(true, '.swh-content code', !{{ iframe_mode|jsonify }});
        }
      {% endif %}
</script>
{% endif %}
{% endif %}
