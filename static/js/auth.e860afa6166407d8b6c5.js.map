{"version":3,"sources":["webpack://swh.auth/webpack/universalModuleDefinition","webpack://swh.auth/./assets/src/utils/functions.js","webpack://swh.auth/webpack/bootstrap","webpack://swh.auth/webpack/runtime/define property getters","webpack://swh.auth/webpack/runtime/hasOwnProperty shorthand","webpack://swh.auth/webpack/runtime/make namespace object","webpack://swh.auth/./assets/src/bundles/auth/index.js"],"names":["root","factory","exports","module","define","amd","self","handleFetchError","response","ok","csrfPost","url","headers","body","Cookies","get","fetch","credentials","method","removeUrlFragment","history","replaceState","document","title","window","location","pathname","search","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","d","definition","key","o","Object","defineProperty","enumerable","obj","prop","prototype","hasOwnProperty","call","r","Symbol","toStringTag","value","apiTokensTable","errorMessage","message","generateToken","Urls","oidc_generate_bearer_token","displayToken","tokenId","postData","token_id","oidc_get_bearer_token","JSON","stringify","then","text","token","tokenHtml","swh","webapp","showModalHtml","responseText","errorMsg","status","revokeTokens","tokenIds","token_ids","oidc_revoke_bearer_tokens","$","html","length","draw","revokeToken","revokeAllTokens","rowsData","rows","data","i","push","id","applyTokenAction","action","infoText","buttonText","actionData","display","submitCallback","generate","modalTitle","revoke","revokeAll","tokenFormHtml","submit","event","preventDefault","stopPropagation","initProfilePage","ready","on","e","settings","techNote","console","log","DataTable","serverSide","ajax","oidc_list_bearer_tokens","columns","name","render","type","row","Date","toLocaleString","ordering","searching","scrollY","scrollCollapse","hash","tab"],"mappings":"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","file":"js/auth.e860afa6166407d8b6c5.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"swh\"] = factory();\n\telse\n\t\troot[\"swh\"] = root[\"swh\"] || {}, root[\"swh\"][\"auth\"] = factory();\n})(self, function() {\nreturn ","/**\n * Copyright (C) 2018-2020  The Software Heritage developers\n * See the AUTHORS file at the top-level directory of this distribution\n * License: GNU Affero General Public License version 3, or any later version\n * See top-level LICENSE file for more information\n */\n\n// utility functions\n\nexport function handleFetchError(response) {\n  if (!response.ok) {\n    throw response;\n  }\n  return response;\n}\n\nexport function handleFetchErrors(responses) {\n  for (let i = 0; i < responses.length; ++i) {\n    if (!responses[i].ok) {\n      throw responses[i];\n    }\n  }\n  return responses;\n}\n\nexport function staticAsset(asset) {\n  return `${__STATIC__}${asset}`;\n}\n\nexport function csrfPost(url, headers = {}, body = null) {\n  headers['X-CSRFToken'] = Cookies.get('csrftoken');\n  return fetch(url, {\n    credentials: 'include',\n    headers: headers,\n    method: 'POST',\n    body: body\n  });\n}\n\nexport function isGitRepoUrl(url, pathPrefix = '/') {\n  let allowedProtocols = ['http:', 'https:', 'git:'];\n  if (allowedProtocols.find(protocol => protocol === url.protocol) === undefined) {\n    return false;\n  }\n  if (!url.pathname.startsWith(pathPrefix)) {\n    return false;\n  }\n  let re = new RegExp('[\\\\w\\\\.-]+\\\\/?(?!=.git)(?:\\\\.git\\\\/?)?$');\n  return re.test(url.pathname.slice(pathPrefix.length));\n};\n\nexport function removeUrlFragment() {\n  history.replaceState('', document.title, window.location.pathname + window.location.search);\n}\n\nexport function selectText(startNode, endNode) {\n  let selection = window.getSelection();\n  selection.removeAllRanges();\n  let range = document.createRange();\n  range.setStart(startNode, 0);\n  if (endNode.nodeName !== '#text') {\n    range.setEnd(endNode, endNode.childNodes.length);\n  } else {\n    range.setEnd(endNode, endNode.textContent.length);\n  }\n  selection.addRange(range);\n}\n\nexport function htmlAlert(type, message, closable = false) {\n  let closeButton = '';\n  let extraClasses = '';\n  if (closable) {\n    closeButton =\n      `<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\n        <span aria-hidden=\"true\">&times;</span>\n      </button>`;\n    extraClasses = 'alert-dismissible';\n  }\n  return `<div class=\"alert alert-${type} ${extraClasses}\" role=\"alert\">${message}${closeButton}</div>`;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\n * Copyright (C) 2020  The Software Heritage developers\n * See the AUTHORS file at the top-level directory of this distribution\n * License: GNU Affero General Public License version 3, or any later version\n * See top-level LICENSE file for more information\n */\n\nimport {handleFetchError, csrfPost, removeUrlFragment} from 'utils/functions';\nimport './auth.css';\n\nlet apiTokensTable;\n\nfunction tokenForm(infoText, buttonText) {\n  const form =\n    `<form id=\"swh-token-form\" class=\"text-center\">\n      <p id=\"swh-token-form-text\">${infoText}</p>\n      <input id=\"swh-token-form-submit\" type=\"submit\" value=\"${buttonText}\">\n      <div id=\"swh-token-form-message\"></div>\n    </form>`;\n  return form;\n}\n\nfunction errorMessage(message) {\n  return `<p id=\"swh-token-error-message\" class=\"mt-3 swh-token-form-message\">${message}</p>`;\n}\n\nfunction successMessage(message) {\n  return `<p id=\"swh-token-success-message\" class=\"mt-3 swh-token-form-message\">${message}</p>`;\n}\n\nfunction disableSubmitButton() {\n  $('#swh-token-form-submit').prop('disabled', true);\n}\n\nfunction generateToken() {\n  window.location = Urls.oidc_generate_bearer_token();\n}\n\nfunction displayToken(tokenId) {\n  const postData = {\n    token_id: tokenId\n  };\n  csrfPost(Urls.oidc_get_bearer_token(), {}, JSON.stringify(postData))\n    .then(handleFetchError)\n    .then(response => response.text())\n    .then(token => {\n      const tokenHtml =\n        `<p>Below is your token.</p>\n         <pre id=\"swh-bearer-token\" class=\"mt-3\">${token}</pre>`;\n      swh.webapp.showModalHtml('Display bearer token', tokenHtml);\n    })\n    .catch(response => {\n      response.text().then(responseText => {\n        let errorMsg = 'Internal server error.';\n        if (response.status === 400) {\n          errorMsg = responseText;\n        }\n        swh.webapp.showModalHtml('Display bearer token', errorMessage(errorMsg));\n      });\n    });\n}\n\nfunction revokeTokens(tokenIds) {\n  const postData = {\n    token_ids: tokenIds\n  };\n  csrfPost(Urls.oidc_revoke_bearer_tokens(), {}, JSON.stringify(postData))\n    .then(handleFetchError)\n    .then(() => {\n      disableSubmitButton();\n      $('#swh-token-form-message').html(\n        successMessage(`Bearer token${tokenIds.length > 1 ? 's' : ''} successfully revoked.`));\n      apiTokensTable.draw();\n    })\n    .catch(() => {\n      $('#swh-token-form-message').html(errorMessage('Internal server error.'));\n    });\n}\n\nfunction revokeToken(tokenId) {\n  revokeTokens([tokenId]);\n}\n\nfunction revokeAllTokens() {\n  const tokenIds = [];\n  const rowsData = apiTokensTable.rows().data();\n  for (let i = 0; i < rowsData.length; ++i) {\n    tokenIds.push(rowsData[i].id);\n  }\n  revokeTokens(tokenIds);\n}\n\nexport function applyTokenAction(action, tokenId) {\n  const actionData = {\n    display: {\n      submitCallback: displayToken\n    },\n    generate: {\n      modalTitle: 'Bearer token generation',\n      infoText: 'Click on the button to generate the token. You will be redirected to ' +\n                'Software Heritage Authentication Service and might be asked to enter ' +\n                'your password again.',\n      buttonText: 'Generate token',\n      submitCallback: generateToken\n    },\n    revoke: {\n      modalTitle: 'Revoke bearer token',\n      infoText: 'Click on the button to revoke the token.',\n      buttonText: 'Revoke token',\n      submitCallback: revokeToken\n    },\n    revokeAll: {\n      modalTitle: 'Revoke all bearer tokens',\n      infoText: 'Click on the button to revoke all tokens.',\n      buttonText: 'Revoke tokens',\n      submitCallback: revokeAllTokens\n    }\n  };\n\n  if (!actionData[action]) {\n    return;\n  }\n\n  if (action !== 'display') {\n    const tokenFormHtml = tokenForm(\n      actionData[action].infoText, actionData[action].buttonText);\n\n    swh.webapp.showModalHtml(actionData[action].modalTitle, tokenFormHtml);\n    $(`#swh-token-form`).submit(event => {\n      event.preventDefault();\n      event.stopPropagation();\n      actionData[action].submitCallback(tokenId);\n    });\n  } else {\n    actionData[action].submitCallback(tokenId);\n  }\n}\n\nexport function initProfilePage() {\n  $(document).ready(() => {\n    apiTokensTable = $('#swh-bearer-tokens-table')\n      .on('error.dt', (e, settings, techNote, message) => {\n        $('#swh-origin-save-request-list-error').text(\n          'An error occurred while retrieving the tokens list');\n        console.log(message);\n      })\n      .DataTable({\n        serverSide: true,\n        ajax: Urls.oidc_list_bearer_tokens(),\n        columns: [\n          {\n            data: 'creation_date',\n            name: 'creation_date',\n            render: (data, type, row) => {\n              if (type === 'display') {\n                let date = new Date(data);\n                return date.toLocaleString();\n              }\n              return data;\n            }\n          },\n          {\n            render: (data, type, row) => {\n              const html =\n                `<button class=\"btn btn-default\"\n                         onclick=\"swh.auth.applyTokenAction('display', ${row.id})\">\n                  Display token\n                </button>\n                <button class=\"btn btn-default\"\n                        onclick=\"swh.auth.applyTokenAction('revoke', ${row.id})\">\n                  Revoke token\n                </button>`;\n              return html;\n            }\n          }\n        ],\n        ordering: false,\n        searching: false,\n        scrollY: '50vh',\n        scrollCollapse: true\n      });\n    $('#swh-oidc-profile-tokens-tab').on('shown.bs.tab', () => {\n      apiTokensTable.draw();\n      window.location.hash = '#tokens';\n    });\n    $('#swh-oidc-profile-account-tab').on('shown.bs.tab', () => {\n      removeUrlFragment();\n    });\n    if (window.location.hash === '#tokens') {\n      $('.nav-tabs a[href=\"#swh-oidc-profile-tokens\"]').tab('show');\n    }\n  });\n}\n"],"sourceRoot":""}