!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.swh=t():(e.swh=e.swh||{},e.swh.save=t())}(self,(function(){return function(){"use strict";var e={80893:function(e,t,n){n.d(t,{XC:function(){return s}});var s=(0,n(55423).TT)("img/swh-spinner.gif")},55423:function(e,t,n){function s(e){if(!e.ok)throw e;return e}function a(e){return"/static/"+e}function r(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=null),t["X-CSRFToken"]=Cookies.get("csrftoken"),fetch(e,{credentials:"include",headers:t,method:"POST",body:n})}function i(e,t){void 0===t&&(t="/");return void 0!==["http:","https:","git:"].find((function(t){return t===e.protocol}))&&(!!e.pathname.startsWith(t)&&new RegExp("[\\w\\.-]+\\/?(?!=.git)(?:\\.git\\/?)?$").test(e.pathname.slice(t.length)))}function o(){history.replaceState("",document.title,window.location.pathname+window.location.search)}function u(e,t,n){void 0===n&&(n=!1);var s="",a="";return n&&(s='<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n        <span aria-hidden="true">&times;</span>\n      </button>',a="alert-dismissible"),'<div class="alert alert-'+e+" "+a+'" role="alert">'+t+s+"</div>"}n.d(t,{ry:function(){return s},TT:function(){return a},e_:function(){return r},Eg:function(){return i},L3:function(){return o},EM:function(){return u}})}},t={};function n(s){var a=t[s];if(void 0!==a)return a.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return function(){n.r(s),n.d(s,{initOriginSave:function(){return u},validateSaveOriginUrl:function(){return l},initTakeNewSnapshot:function(){return c},displaySaveRequestInfo:function(){return d},fillSaveRequestFormAndScroll:function(){return p}});var e,t=n(55423),a=n(80893);function r(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var s=0;return function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}function o(e,n,s,a,r){var i=Urls.origin_save_request(e,n);$(".swh-processing-save-request").css("display","block"),(0,t.e_)(i,{Accept:"application/json","Content-Type":"application/json"}).then(t.ry).then((function(e){return e.json()})).then((function(e){$(".swh-processing-save-request").css("display","none"),"accepted"===e.save_request_status?s():a()})).catch((function(e){$(".swh-processing-save-request").css("display","none"),e.json().then((function(t){r(e.status,t)}))}))}function u(){$(document).ready((function(){$.fn.dataTable.ext.errMode="none",fetch(Urls.origin_save_types_list()).then((function(e){return e.json()})).then((function(e){for(var t,n=r(e);!(t=n()).done;){var s=t.value;$("#swh-input-visit-type").append('<option value="'+s+'">'+s+"</option>")}})),e=$("#swh-origin-save-requests").on("error.dt",(function(e,t,n,s){$("#swh-origin-save-request-list-error").text("An error occurred while retrieving the save requests list"),console.log(s)})).DataTable({serverSide:!0,processing:!0,language:{processing:'<img src="'+a.XC+'"></img>'},ajax:Urls.origin_save_requests_list("all"),searchDelay:1e3,columns:[{data:"save_request_date",name:"request_date",render:function(e,t,n){return"display"===t?new Date(e).toLocaleString():e}},{data:"visit_type",name:"visit_type"},{data:"origin_url",name:"origin_url",render:function(e,t,n){if("display"===t){var s="",a=$.fn.dataTable.render.text().display(e);if("succeeded"===n.save_task_status){var r=Urls.browse_origin()+"?origin_url="+encodeURIComponent(a);n.visit_date&&(r+="&amp;timestamp="+encodeURIComponent(n.visit_date)),s+='<a href="'+r+'">'+a+"</a>"}else s+=a;return s+='&nbsp;<a href="'+a+'"><i class="mdi mdi-open-in-new" aria-hidden="true"></i></a>'}return e}},{data:"save_request_status",name:"status"},{data:"save_task_status",name:"loading_task_status"},{name:"info",render:function(e,t,n){return"succeeded"===n.save_task_status||"failed"===n.save_task_status?'<i class="mdi mdi-information-outline swh-save-request-info" aria-hidden="true" style="cursor: pointer"onclick="swh.save.displaySaveRequestInfo(event, '+n.id+')"></i>':""}},{render:function(e,t,n){return"accepted"===n.save_request_status?'<button class="btn btn-default btn-sm swh-save-origin-again" type="button" onclick="swh.save.fillSaveRequestFormAndScroll(\''+n.visit_type+"', '"+n.origin_url+'\');"><i class="mdi mdi-camera mdi-fw" aria-hidden="true"></i>Save again</button>':""}}],scrollY:"50vh",scrollCollapse:!0,order:[[0,"desc"]],responsive:{details:{type:"none"}}}),swh.webapp.addJumpToPagePopoverToDataTable(e),$("#swh-origin-save-requests-list-tab").on("shown.bs.tab",(function(){e.draw(),window.location.hash="#requests"})),$("#swh-origin-save-request-help-tab").on("shown.bs.tab",(function(){(0,t.L3)(),$(".swh-save-request-info").popover("dispose")}));var n=(0,t.EM)("success",'The "save code now" request has been accepted and will be processed as soon as possible.',!0),s=(0,t.EM)("warning",'The "save code now" request has been put in pending state and may be accepted for processing after manual review.',!0),i=(0,t.EM)("danger",'The rate limit for "save code now" requests has been reached. Please try again later.',!0),u=(0,t.EM)("danger",'An unexpected error happened when submitting the "save code now request".',!0);$("#swh-save-origin-form").submit((function(e){(e.preventDefault(),e.stopPropagation(),$(".alert").alert("close"),e.target.checkValidity())?($(e.target).removeClass("was-validated"),o($("#swh-input-visit-type").val(),$("#swh-input-origin-url").val(),(function(){return $("#swh-origin-save-request-status").html(n)}),(function(){return $("#swh-origin-save-request-status").html(s)}),(function(e,n){if($("#swh-origin-save-request-status").css("color","red"),403===e){var s=(0,t.EM)("danger","Error: "+n.detail);$("#swh-origin-save-request-status").html(s)}else 429===e?$("#swh-origin-save-request-status").html(i):$("#swh-origin-save-request-status").html(u)}))):$(e.target).addClass("was-validated")})),$("#swh-show-origin-save-requests-list").on("click",(function(e){e.preventDefault(),$('.nav-tabs a[href="#swh-origin-save-requests-list"]').tab("show")})),$("#swh-input-origin-url").on("input",(function(e){var t=$(this).val().trim();$(this).val(t),$("#swh-input-visit-type option").each((function(){var e=$(this).val();e&&t.includes(e)&&$(this).prop("selected",!0)}))})),"#requests"===window.location.hash&&$('.nav-tabs a[href="#swh-origin-save-requests-list"]').tab("show")}))}function l(e){var n=$("#swh-input-visit-type").val(),s=null,a=!0;try{s=new URL(e.value.trim())}catch(e){a=!1}if(a){a=void 0!==["http:","https:","svn:","git:"].find((function(e){return e===s.protocol}))}if(a&&"git"===n)switch(s.hostname){case"github.com":a=(0,t.Eg)(s);break;case"git.code.sf.net":a=(0,t.Eg)(s,"/p/");break;case"bitbucket.org":a=(0,t.Eg)(s);break;default:s.hostname.startsWith("gitlab.")&&(a=(0,t.Eg)(s))}a?e.setCustomValidity(""):e.setCustomValidity("The origin url is not valid or does not reference a code repository")}function c(){var e=(0,t.EM)("success",'The "take new snapshot" request has been accepted and will be processed as soon as possible.',!0),n=(0,t.EM)("warning",'The "take new snapshot" request has been put in pending state and may be accepted for processing after manual review.',!0),s=(0,t.EM)("danger",'The rate limit for "take new snapshot" requests has been reached. Please try again later.',!0),a=(0,t.EM)("danger",'An unexpected error happened when submitting the "save code now request".',!0);$(document).ready((function(){$("#swh-take-new-snapshot-form").submit((function(r){r.preventDefault(),r.stopPropagation(),o($("#swh-input-visit-type").val(),$("#swh-input-origin-url").val(),(function(){return $("#swh-take-new-snapshot-request-status").html(e)}),(function(){return $("#swh-take-new-snapshot-request-status").html(n)}),(function(e,n){if($("#swh-take-new-snapshot-request-status").css("color","red"),403===e){var r=(0,t.EM)("danger","Error: "+n.detail,!0);$("#swh-take-new-snapshot-request-status").html(r)}else 429===e?$("#swh-take-new-snapshot-request-status").html(s):$("#swh-take-new-snapshot-request-status").html(a)}))}))}))}function d(e,t){e.stopPropagation();var n=Urls.origin_save_task_info(t);$(e.target).data("bs.popover")?$(e.target).popover("dispose"):($(".swh-save-request-info").popover("dispose"),$(e.target).popover({animation:!1,boundary:"viewport",container:"body",title:'Save request task information <i style="cursor: pointer; position: absolute; right: 1rem;" class="mdi mdi-close swh-save-request-info-close"></i>',content:'<div class="swh-popover swh-save-request-info-popover">\n                  <div class="text-center">\n                    <img src='+a.XC+"></img>\n                    <p>Fetching task information ...</p>\n                  </div>\n                </div>",html:!0,placement:"left",sanitizeFn:swh.webapp.filterXSS}),$(e.target).on("shown.bs.popover",(function(){var e=this,t=$(this).attr("aria-describedby");$("#"+t+" .mdi-close").click((function(){$(e).popover("dispose")}))})),$(e.target).popover("show"),fetch(n).then((function(e){return e.json()})).then((function(t){var n;if($.isEmptyObject(t))n="Not available";else{var s=[];t.type&&s.push({key:"Task type",value:t.type}),t.arguments&&s.push({key:"Task arguments",value:JSON.stringify(t.arguments,null,2)}),t.id&&s.push({key:"Task id",value:t.id}),t.backend_id&&s.push({key:"Task backend id",value:t.backend_id}),t.scheduled&&s.push({key:"Task scheduling date",value:new Date(t.scheduled).toLocaleString()}),t.started&&s.push({key:"Task start date",value:new Date(t.started).toLocaleString()}),t.ended&&s.push({key:"Task termination date",value:new Date(t.ended).toLocaleString()}),t.duration&&s.push({key:"Task duration",value:t.duration+" seconds"}),t.worker&&s.push({key:"Task executor",value:t.worker}),t.message&&s.push({key:"Task log",value:t.message}),n='<table class="table"><tbody>';for(var a=0,r=s;a<r.length;a++){var i=r[a];n+='<tr>\n              <th class="swh-metadata-table-row swh-metadata-table-key">'+i.key+'</th>\n              <td class="swh-metadata-table-row swh-metadata-table-value">\n                <pre>'+i.value+"</pre>\n              </td>\n            </tr>"}n+="</tbody></table>"}$(".swh-popover").html(n),$(e.target).popover("update")})))}function p(e,t){$("#swh-input-origin-url").val(t);var n=!1;$("#swh-input-visit-type option").each((function(){var e=$(this).val();e&&t.includes(e)&&($(this).prop("selected",!0),n=!0)})),n||$("#swh-input-visit-type option").each((function(){$(this).val()===e&&$(this).prop("selected",!0)})),window.scrollTo(0,0)}}(),s}()}));
//# sourceMappingURL=save.d59ccda4639c6cc6d27f.js.map