!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.vault=e():(t.swh=t.swh||{},t.swh.vault=e())}(window,(function(){return function(t){var e={};function n(o){if(e[o])return e[o].exports;var a=e[o]={i:o,l:!1,exports:{}};return t[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(o,a,function(e){return t[e]}.bind(null,a));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/static/",n(n.s=264)}({167:function(t,e,n){"use strict";n.d(e,"a",(function(){return u})),n.d(e,"c",(function(){return l})),n.d(e,"d",(function(){return _})),n.d(e,"b",(function(){return f}));var o,a,r=n(2),i=n(229),c=n.n(i),s=5e3;function d(t,e){"new"===e.status?t.css("background-color","rgba(128, 128, 128, 0.5)"):"pending"===e.status?t.css("background-color","rgba(0, 0, 255, 0.5)"):"done"===e.status?t.css("background-color","#5cb85c"):"failed"===e.status&&(t.css("background-color","rgba(255, 0, 0, 0.5)"),t.css("background-image","none")),t.text(e.progress_message||e.status),"new"===e.status||"pending"===e.status?t.addClass("progress-bar-animated"):t.removeClass("progress-bar-striped")}function u(t){a=null,fetch(t).then((function(e){if(e.ok)$("#vault-fetch-iframe").attr("src",t);else{for(var n=JSON.parse(localStorage.getItem("swh-vault-cooking-tasks")),o=0;o<n.length;++o)if(n[o].fetch_url===t){a=n[o];break}$("#vault-recook-object-modal").modal("show")}}))}function l(){var t;a&&(clearTimeout(o),t="directory"===a.object_type?Urls.api_1_vault_cook_directory(a.object_id):Urls.api_1_vault_cook_revision_gitfast(a.object_id),a.email&&(t+="?email="+a.email),Object(r.a)(t).then(r.b).then((function(){a.status="new";for(var t=JSON.parse(localStorage.getItem("swh-vault-cooking-tasks")),e=0;e<t.length;++e)if(t[e].object_id===a.object_id){t[e]=a;break}localStorage.setItem("swh-vault-cooking-tasks",JSON.stringify(t)),p(),$("#vault-recook-object-modal").modal("hide")})).catch((function(){p(),$("#vault-recook-object-modal").modal("hide")})))}function p(){var t=JSON.parse(localStorage.getItem("swh-vault-cooking-tasks"));if(!t||0===t.length)return $(".swh-vault-table tbody tr").remove(),void(o=setTimeout(p,s));for(var e=[],n={},a=[],i=0;i<t.length;++i){var u=t[i];a.push(u.object_id),n[u.object_id]=u;var l=void 0;l="directory"===u.object_type?Urls.api_1_vault_cook_directory(u.object_id):Urls.api_1_vault_cook_revision_gitfast(u.object_id),"done"!==u.status&&"failed"!==u.status&&e.push(fetch(l))}$(".swh-vault-table tbody tr").each((function(t,e){var n=$(e).find(".vault-object-info").data("object-id");-1===$.inArray(n,a)&&$(e).remove()})),Promise.all(e).then(r.c).then((function(t){return Promise.all(t.map((function(t){return t.json()})))})).then((function(e){for(var a=$("#vault-cooking-tasks tbody"),r=0;r<e.length;++r){var i=n[e[r].obj_id];i.status=e[r].status,i.fetch_url=e[r].fetch_url,i.progress_message=e[r].progress_message}for(var u=0;u<t.length;++u){var l=t[u],_=$("#vault-task-"+l.object_id);if(_.length){d(_.find(".progress-bar"),l);var f=_.find(".vault-dl-link");"done"===l.status?f[0].innerHTML='<button class="btn btn-default btn-sm" onclick="swh.vault.fetchCookedObject(\''+l.fetch_url+'\')"><i class="mdi mdi-download mdi-fw" aria-hidden="true"></i>Download</button>':f[0].innerHTML=""}else{var b=l.browse_url;b||(b="directory"===l.object_type?Urls.browse_directory(l.object_id):Urls.browse_revision(l.object_id));var v=$.parseHTML('<div class="progress">\n    <div class="progress-bar progress-bar-success progress-bar-striped"\n          role="progressbar" aria-valuenow="100" aria-valuemin="0"\n          aria-valuemax="100" style="width: 100%;height: 100%;">\n    </div>\n  </div>;')[0];d($(v).find(".progress-bar"),l),a.prepend(c()({browseUrl:b,cookingTask:l,progressBar:v,Urls:Urls,swh:swh}))}}localStorage.setItem("swh-vault-cooking-tasks",JSON.stringify(t)),o=setTimeout(p,s)})).catch((function(){}))}function _(t){var e=JSON.parse(localStorage.getItem("swh-vault-cooking-tasks"));e&&(e=$.grep(e,(function(e){return-1===$.inArray(e.object_id,t)})),localStorage.setItem("swh-vault-cooking-tasks",JSON.stringify(e)))}function f(){$("#vault-tasks-toggle-selection").change((function(t){$(".vault-task-toggle-selection").prop("checked",t.currentTarget.checked)})),$("#vault-remove-tasks").click((function(){clearTimeout(o);var t=[];$(".swh-vault-table tbody tr").each((function(e,n){if($(n).find(".vault-task-toggle-selection").prop("checked")){var o=$(n).find(".vault-object-info").data("object-id");t.push(o),$(n).remove()}})),_(t),$("#vault-tasks-toggle-selection").prop("checked",!1),o=setTimeout(p,s)})),p(),window.onfocus=function(){clearTimeout(o),p()}}},168:function(t,e,n){"use strict";n.d(e,"e",(function(){return r})),n.d(e,"a",(function(){return s})),n.d(e,"c",(function(){return d})),n.d(e,"b",(function(){return u})),n.d(e,"d",(function(){return l}));var o=n(2),a={position:"fixed",left:"1rem",bottom:"1rem","z-index":"100000"};function r(t,e){var n;n="directory"===t?Urls.api_1_vault_cook_directory(e):Urls.api_1_vault_cook_revision_gitfast(e),fetch(n).then((function(t){return t.json()})).then((function(n){if("NotFoundExc"===n.exception||"failed"===n.status)swh.vault.removeCookingTaskInfo([e]),$("#vault-cook-"+t+"-modal").modal("show");else if("done"===n.status)$("#vault-fetch-"+t+"-modal").modal("show");else{var r=$(Object(o.d)("danger","Archive cooking service is currently experiencing issues.<br/>Please try again later.",!0));r.css(a),$("body").append(r)}}))}function i(t){var e=swh.webapp.getSwhIdsContext();t.origin=e[t.object_type].context.origin,t.path=e[t.object_type].context.path,t.browse_url=e[t.object_type].swhid_with_context_url,t.browse_url||(t.browse_url=e[t.object_type].swhid_url);var n,r=JSON.parse(localStorage.getItem("swh-vault-cooking-tasks"));(r||(r=[]),void 0===r.find((function(e){return e.object_type===t.object_type&&e.object_id===t.object_id})))&&(n="directory"===t.object_type?Urls.api_1_vault_cook_directory(t.object_id):Urls.api_1_vault_cook_revision_gitfast(t.object_id),t.email&&(n+="?email="+t.email),Object(o.a)(n).then(o.b).then((function(){r.push(t),localStorage.setItem("swh-vault-cooking-tasks",JSON.stringify(r)),$("#vault-cook-directory-modal").modal("hide"),$("#vault-cook-revision-modal").modal("hide");var e=$(Object(o.d)("success",'Archive cooking request successfully submitted.<br/>Go to the <a href="'+Urls.browse_vault()+'">Downloads</a> page to get the download link once it is ready.',!0));e.css(a),$("body").append(e)})).catch((function(){$("#vault-cook-directory-modal").modal("hide"),$("#vault-cook-revision-modal").modal("hide");var t=$(Object(o.d)("danger","Archive cooking request submission failed.",!0));t.css(a),$("body").append(t)})))}function c(t){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(t).toLowerCase())}function s(t){var e=$("#swh-vault-directory-email").val().trim();!e||c(e)?i({object_type:"directory",object_id:t,email:e,status:"new"}):$("#invalid-email-modal").modal("show")}function d(t){$("#vault-fetch-directory-modal").modal("hide");var e=Urls.api_1_vault_cook_directory(t);fetch(e).then((function(t){return t.json()})).then((function(t){swh.vault.fetchCookedObject(t.fetch_url)}))}function u(t){var e=$("#swh-vault-revision-email").val().trim();!e||c(e)?i({object_type:"revision",object_id:t,email:e,status:"new"}):$("#invalid-email-modal").modal("show")}function l(t){$("#vault-fetch-directory-modal").modal("hide");var e=Urls.api_1_vault_cook_revision_gitfast(t);fetch(e).then((function(t){return t.json()})).then((function(t){swh.vault.fetchCookedObject(t.fetch_url)}))}},2:function(t,e,n){"use strict";function o(t){if(!t.ok)throw t;return t}function a(t){for(var e=0;e<t.length;++e)if(!t[e].ok)throw t[e];return t}function r(t){return"/static/"+t}function i(t,e,n){return void 0===e&&(e={}),void 0===n&&(n=null),e["X-CSRFToken"]=Cookies.get("csrftoken"),fetch(t,{credentials:"include",headers:e,method:"POST",body:n})}function c(t,e){return new RegExp("(?:git|https?|git@)(?:\\:\\/\\/)?"+e+"[/|:][A-Za-z0-9-/]+?\\/[\\w\\.-]+\\/?(?!=.git)(?:\\.git(?:\\/?|\\#[\\w\\.\\-_]+)?)?$").test(t)}function s(){history.replaceState("",document.title,window.location.pathname+window.location.search)}function d(t,e){var n=window.getSelection();n.removeAllRanges();var o=document.createRange();o.setStart(t,0),"#text"!==e.nodeName?o.setEnd(e,e.childNodes.length):o.setEnd(e,e.textContent.length),n.addRange(o)}function u(t,e,n){void 0===n&&(n=!1);var o="",a="";return n&&(o='<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n        <span aria-hidden="true">&times;</span>\n      </button>',a="alert-dismissible"),'<div class="alert alert-'+t+" "+a+'" role="alert">'+e+o+"</div>"}n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return a})),n.d(e,"h",(function(){return r})),n.d(e,"a",(function(){return i})),n.d(e,"e",(function(){return c})),n.d(e,"f",(function(){return s})),n.d(e,"g",(function(){return d})),n.d(e,"d",(function(){return u}))},229:function(module,exports){module.exports=function anonymous(locals,escapeFn,include,rethrow){escapeFn=escapeFn||function(t){return null==t?"":String(t).replace(_MATCH_HTML,encode_char)};var _ENCODE_HTML_RULES={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},_MATCH_HTML=/[&<>'"]/g;function encode_char(t){return _ENCODE_HTML_RULES[t]||t}var __output="";function __append(t){null!=t&&(__output+=t)}with(locals||{})__append("\n\n"),"directory"===cookingTask.object_type?(__append('\n  <tr id="vault-task-'),__append(escapeFn(cookingTask.object_id)),__append('" title="Once downloaded, the directory can be extracted with the following command:\n\n$ tar xvzf '),__append(escapeFn(cookingTask.object_id)),__append('.tar.gz">\n')):(__append('\n  </tr><tr id="vault-task-'),__append(escapeFn(cookingTask.object_id)),__append('" title="Once downloaded, the git repository can be imported with the following commands:\n\n$ git init\n$ zcat '),__append(escapeFn(cookingTask.object_id)),__append('.gitfast.gz | git fast-import">\n')),__append('\n    <td>\n      <div class="custom-control custom-checkbox">\n      <input type="checkbox" class="custom-control-input vault-task-toggle-selection" id="vault-task-toggle-selection-'),__append(escapeFn(cookingTask.object_id)),__append('">\n      <label class="custom-control-label" for="vault-task-toggle-selection-'),__append(escapeFn(cookingTask.object_id)),__append('">\n      </label>\n    </div></td>\n    '),cookingTask.origin?(__append('\n      <td class="vault-origin">\n        <a href="'),__append(escapeFn(Urls.browse_origin())),__append("?origin_url="),__append(escapeFn(cookingTask.origin)),__append('">\n          '),__append(escapeFn(decodeURIComponent(cookingTask.origin))),__append("\n        </a>\n      </td>\n    ")):__append('\n      <td class="vault-origin">unknown</td>\n    '),__append('\n    <td>\n      <i class="'),__append(escapeFn(swh.webapp.getSwhObjectIcon(cookingTask.object_type))),__append(' mdi-fw"></i>\n      '),__append(escapeFn(cookingTask.object_type)),__append('\n    </td>\n    <td class="vault-object-info" data-object-id="'),__append(escapeFn(cookingTask.object_id)),__append('">\n      <b>id:</b>&nbsp;<a href="'),__append(escapeFn(browseUrl)),__append('">'),__append(escapeFn(cookingTask.object_id)),__append("</a>\n      "),cookingTask.path&&(__append("\n        <br><b>path:</b>&nbsp;"),__append(escapeFn(cookingTask.path)),__append("\n      ")),__append("\n    </td>\n    <td>"),__append(progressBar.outerHTML),__append('</td>\n    <td class="vault-dl-link">\n      '),"done"===cookingTask.status&&(__append('\n        <button class="btn btn-default btn-sm" onclick="swh.vault.fetchCookedObject(\''),__append(escapeFn(cookingTask.fetch_url)),__append('\')">\n          <i class="mdi mdi-download mdi-fw" aria-hidden="true"></i>Download\n        </button>\n      ')),__append("\n    </td>\n  </tr>");return __output}},264:function(t,e,n){t.exports=n(265)},265:function(t,e,n){"use strict";n.r(e);n(266);var o=n(167);n.d(e,"fetchCookedObject",(function(){return o.a})),n.d(e,"recookObject",(function(){return o.c})),n.d(e,"removeCookingTaskInfo",(function(){return o.d})),n.d(e,"initUi",(function(){return o.b}));var a=n(168);n.d(e,"vaultRequest",(function(){return a.e})),n.d(e,"cookDirectoryArchive",(function(){return a.a})),n.d(e,"fetchDirectoryArchive",(function(){return a.c})),n.d(e,"cookRevisionArchive",(function(){return a.b})),n.d(e,"fetchRevisionArchive",(function(){return a.d}))},266:function(t,e,n){}})}));
//# sourceMappingURL=vault.7740f26804d63bf83b3d.js.map