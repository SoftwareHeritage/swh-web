!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.swh=t():(e.swh=e.swh||{},e.swh.save=t())}(self,(function(){return function(){"use strict";var e={80893:function(e,t,n){n.d(t,{XC:function(){return s}});var s=(0,n(55423).TT)("img/swh-spinner.gif")},55423:function(e,t,n){function s(e){if(!e.ok)throw e;return e}function r(e){return"/static/"+e}function a(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=null),t["X-CSRFToken"]=Cookies.get("csrftoken"),fetch(e,{credentials:"include",headers:t,method:"POST",body:n})}function i(e,t){void 0===t&&(t="/");return void 0!==["http:","https:","git:"].find((function(t){return t===e.protocol}))&&(!!e.pathname.startsWith(t)&&new RegExp("[\\w\\.-]+\\/?(?!=.git)(?:\\.git\\/?)?$").test(e.pathname.slice(t.length)))}function o(){history.replaceState("",document.title,window.location.pathname+window.location.search)}function u(e,t,n){void 0===n&&(n=!1);var s="",r="";return n&&(s='<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n        <span aria-hidden="true">&times;</span>\n      </button>',r="alert-dismissible"),'<div class="alert alert-'+e+" "+r+'" role="alert">'+t+s+"</div>"}n.d(t,{ry:function(){return s},TT:function(){return r},e_:function(){return a},Eg:function(){return i},L3:function(){return o},EM:function(){return u}})}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,n),a.exports}n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return function(){n.r(s),n.d(s,{initOriginSave:function(){return u},validateSaveOriginUrl:function(){return l},initTakeNewSnapshot:function(){return c},formatValuePerType:function(){return d},displaySaveRequestInfo:function(){return p},fillSaveRequestFormAndScroll:function(){return h}});var e,t=n(55423),r=n(80893);function a(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var s=0;return function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=new Array(t);n<t;n++)s[n]=e[n];return s}function o(e,n,s,r,a){var i=Urls.api_1_save_origin(e,n);$(".swh-processing-save-request").css("display","block"),(0,t.e_)(i).then(t.ry).then((function(e){return e.json()})).then((function(e){$(".swh-processing-save-request").css("display","none"),"accepted"===e.save_request_status?s():r()})).catch((function(e){$(".swh-processing-save-request").css("display","none"),e.json().then((function(t){a(e.status,t)}))}))}function u(){$(document).ready((function(){$.fn.dataTable.ext.errMode="none",fetch(Urls.origin_save_types_list()).then((function(e){return e.json()})).then((function(e){for(var t,n=a(e);!(t=n()).done;){var s=t.value;$("#swh-input-visit-type").append('<option value="'+s+'">'+s+"</option>")}})),e=$("#swh-origin-save-requests").on("error.dt",(function(e,t,n,s){$("#swh-origin-save-request-list-error").text("An error occurred while retrieving the save requests list"),console.log(s)})).DataTable({serverSide:!0,processing:!0,language:{processing:'<img src="'+r.XC+'"></img>'},ajax:Urls.origin_save_requests_list("all"),searchDelay:1e3,columns:[{data:"save_request_date",name:"request_date",render:function(e,t,n){return"display"===t?new Date(e).toLocaleString():e}},{data:"visit_type",name:"visit_type"},{data:"origin_url",name:"origin_url",render:function(e,t,n){if("display"===t){var s="",r=$.fn.dataTable.render.text().display(e);if("succeeded"===n.save_task_status){var a=Urls.browse_origin()+"?origin_url="+encodeURIComponent(r);n.visit_date&&(a+="&amp;timestamp="+encodeURIComponent(n.visit_date)),s+='<a href="'+a+'">'+r+"</a>"}else s+=r;return s+='&nbsp;<a href="'+r+'"><i class="mdi mdi-open-in-new" aria-hidden="true"></i></a>'}return e}},{data:"save_request_status",name:"status"},{data:"save_task_status",name:"loading_task_status"},{name:"info",render:function(e,t,n){return"succeeded"===n.save_task_status||"failed"===n.save_task_status?'<i class="mdi mdi-information-outline swh-save-request-info" aria-hidden="true" style="cursor: pointer"onclick="swh.save.displaySaveRequestInfo(event, '+n.id+')"></i>':""}},{render:function(e,t,n){return"accepted"===n.save_request_status?'<button class="btn btn-default btn-sm swh-save-origin-again" type="button" onclick="swh.save.fillSaveRequestFormAndScroll(\''+n.visit_type+"', '"+n.origin_url+'\');"><i class="mdi mdi-camera mdi-fw" aria-hidden="true"></i>Save again</button>':""}}],scrollY:"50vh",scrollCollapse:!0,order:[[0,"desc"]],responsive:{details:{type:"none"}}}),swh.webapp.addJumpToPagePopoverToDataTable(e),$("#swh-origin-save-requests-list-tab").on("shown.bs.tab",(function(){e.draw(),window.location.hash="#requests"})),$("#swh-origin-save-request-help-tab").on("shown.bs.tab",(function(){(0,t.L3)(),$(".swh-save-request-info").popover("dispose")}));var n=(0,t.EM)("success",'The "save code now" request has been accepted and will be processed as soon as possible.',!0),s=(0,t.EM)("warning",'The "save code now" request has been put in pending state and may be accepted for processing after manual review.',!0),i=(0,t.EM)("danger",'The rate limit for "save code now" requests has been reached. Please try again later.',!0),u=(0,t.EM)("danger",'An unexpected error happened when submitting the "save code now request".',!0);$("#swh-save-origin-form").submit((function(e){(e.preventDefault(),e.stopPropagation(),$(".alert").alert("close"),e.target.checkValidity())?($(e.target).removeClass("was-validated"),o($("#swh-input-visit-type").val(),$("#swh-input-origin-url").val(),(function(){return $("#swh-origin-save-request-status").html(n)}),(function(){return $("#swh-origin-save-request-status").html(s)}),(function(e,n){if($("#swh-origin-save-request-status").css("color","red"),403===e){var s=(0,t.EM)("danger","Error: "+n.reason);$("#swh-origin-save-request-status").html(s)}else if(429===e)$("#swh-origin-save-request-status").html(i);else if(400===e){var r=(0,t.EM)("danger",n.reason);$("#swh-origin-save-request-status").html(r)}else $("#swh-origin-save-request-status").html(u)}))):$(e.target).addClass("was-validated")})),$("#swh-show-origin-save-requests-list").on("click",(function(e){e.preventDefault(),$('.nav-tabs a[href="#swh-origin-save-requests-list"]').tab("show")})),$("#swh-input-origin-url").on("input",(function(e){var t=$(this).val().trim();$(this).val(t),$("#swh-input-visit-type option").each((function(){var e=$(this).val();e&&t.includes(e)&&$(this).prop("selected",!0)}))})),"#requests"===window.location.hash&&$('.nav-tabs a[href="#swh-origin-save-requests-list"]').tab("show")}))}function l(e){var n=$("#swh-input-visit-type").val(),s=null,r=!0;try{s=new URL(e.value.trim())}catch(e){r=!1}if(r){r=void 0!==["http:","https:","svn:","git:"].find((function(e){return e===s.protocol}))}if(r&&"git"===n)switch(s.hostname){case"github.com":r=(0,t.Eg)(s);break;case"git.code.sf.net":r=(0,t.Eg)(s,"/p/");break;case"bitbucket.org":r=(0,t.Eg)(s);break;default:s.hostname.startsWith("gitlab.")&&(r=(0,t.Eg)(s))}r?e.setCustomValidity(""):e.setCustomValidity("The origin url is not valid or does not reference a code repository")}function c(){var e=(0,t.EM)("success",'The "take new snapshot" request has been accepted and will be processed as soon as possible.',!0),n=(0,t.EM)("warning",'The "take new snapshot" request has been put in pending state and may be accepted for processing after manual review.',!0),s=(0,t.EM)("danger",'The rate limit for "take new snapshot" requests has been reached. Please try again later.',!0),r=(0,t.EM)("danger",'An unexpected error happened when submitting the "save code now request".',!0);$(document).ready((function(){$("#swh-take-new-snapshot-form").submit((function(a){a.preventDefault(),a.stopPropagation(),o($("#swh-input-visit-type").val(),$("#swh-input-origin-url").val(),(function(){return $("#swh-take-new-snapshot-request-status").html(e)}),(function(){return $("#swh-take-new-snapshot-request-status").html(n)}),(function(e,n){if($("#swh-take-new-snapshot-request-status").css("color","red"),403===e){var a=(0,t.EM)("danger","Error: "+n.detail,!0);$("#swh-take-new-snapshot-request-status").html(a)}else 429===e?$("#swh-take-new-snapshot-request-status").html(s):$("#swh-take-new-snapshot-request-status").html(r)}))}))}))}function d(e,t){return null===t?null:{json:function(e){return JSON.stringify(e,null,2)},date:function(e){return new Date(e).toLocaleString()},raw:function(e){return e},duration:function(e){return e+" seconds"}}[e](t)}function p(e,t){e.stopPropagation();var n=Urls.origin_save_task_info(t);$(e.target).data("bs.popover")?$(e.target).popover("dispose"):($(".swh-save-request-info").popover("dispose"),$(e.target).popover({animation:!1,boundary:"viewport",container:"body",title:'Save request task information <i style="cursor: pointer; position: absolute; right: 1rem;" class="mdi mdi-close swh-save-request-info-close"></i>',content:'<div class="swh-popover swh-save-request-info-popover">\n                  <div class="text-center">\n                    <img src='+r.XC+"></img>\n                    <p>Fetching task information ...</p>\n                  </div>\n                </div>",html:!0,placement:"left",sanitizeFn:swh.webapp.filterXSS}),$(e.target).on("shown.bs.popover",(function(){var e=this,t=$(this).attr("aria-describedby");$("#"+t+" .mdi-close").click((function(){$(e).popover("dispose")}))})),$(e.target).popover("show"),fetch(n).then((function(e){return e.json()})).then((function(t){var n;if($.isEmptyObject(t))n="Not available";else{for(var s=[],r=0,a=Object.entries({Type:["raw","type"],"Visit status":["raw","visit_status"],Arguments:["json","arguments"],Id:["raw","id"],"Backend id":["raw","backend_id"],"Scheduling date":["date","scheduled"],"Start date":["date","started"],"Completion date":["date","ended"],Duration:["duration","duration"],Runner:["raw","worker"],Log:["raw","message"]});r<a.length;r++){var i=a[r],o=i[0],u=i[1],l=u[0],c=u[1];t.hasOwnProperty(c)&&s.push({key:o,value:d(l,t[c])})}n='<table class="table"><tbody>';for(var p=0,h=s;p<h.length;p++){var v=h[p];n+='<tr>\n              <th class="swh-metadata-table-row swh-metadata-table-key">'+v.key+'</th>\n              <td class="swh-metadata-table-row swh-metadata-table-value">\n                <pre>'+v.value+"</pre>\n              </td>\n            </tr>"}n+="</tbody></table>"}$(".swh-popover").html(n),$(e.target).popover("update")})))}function h(e,t){$("#swh-input-origin-url").val(t);var n=!1;$("#swh-input-visit-type option").each((function(){var e=$(this).val();e&&t.includes(e)&&($(this).prop("selected",!0),n=!0)})),n||$("#swh-input-visit-type option").each((function(){$(this).val()===e&&$(this).prop("selected",!0)})),window.scrollTo(0,0)}}(),s}()}));
//# sourceMappingURL=save.a4fc3610c0ded2111ef4.js.map